name: Build and Deploy

on:
  pull_request:
    branches:
      - main
      - 'release/*'
  push:
    branches:
      - main
      - 'release/*'
  workflow_dispatch:
    inputs:
      release:
        description: 'Produce a GA release (no prerelease suffix). Only valid on release/* branches.'
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Restore
        run: dotnet restore Sigstore.slnx

      - name: Build
        run: dotnet build Sigstore.slnx --no-restore

      - name: Test
        run: |
          dotnet test Sigstore.slnx \
            --no-build \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory ./TestResults

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Test Results
          path: ./TestResults/*.trx
          reporter: dotnet-trx

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: test-results
          path: ./TestResults/

  build:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      base_version: ${{ steps.version.outputs.base_version }}
      is_release: ${{ steps.version.outputs.is_release }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        uses: ./.github/actions/version
        with:
          release: ${{ inputs.release || false }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Pack
        run: |
          dotnet pack src/Tuf/Tuf.csproj \
            -c Release \
            -p:PackageVersion=${{ steps.version.outputs.version }} \
            -o ./artifacts
          dotnet pack src/Sigstore/Sigstore.csproj \
            -c Release \
            -p:PackageVersion=${{ steps.version.outputs.version }} \
            -o ./artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts/*.nupkg

  publish-github:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.outputs.is_release != 'true' }}
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Post package info to PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PACKAGE_VERSION: ${{ needs.build.outputs.version }}
        run: |
          # Delete previous package comments
          gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json comments \
            --jq '.comments[]? | select(.body | startswith("## ðŸ“¦ Package Published")) | .databaseId' 2>/dev/null | \
          while IFS= read -r comment_id; do
            if [ -n "$comment_id" ]; then
              gh api --method DELETE \
                -H "Accept: application/vnd.github+json" \
                "/repos/${{ github.repository }}/issues/comments/$comment_id" || true
            fi
          done

          cat > /tmp/pr_comment.md << EOF
          ## ðŸ“¦ Package Published

          **Version:** \`${PACKAGE_VERSION}\`

          \`\`\`bash
          dotnet add package Sigstore --version ${PACKAGE_VERSION}
          dotnet add package Tuf --version ${PACKAGE_VERSION}
          \`\`\`

          \`\`\`xml
          <PackageReference Include="Sigstore" Version="${PACKAGE_VERSION}" />
          <PackageReference Include="Tuf" Version="${PACKAGE_VERSION}" />
          \`\`\`

          > Requires [GitHub Packages NuGet source](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry) configured.

          ---
          *Published at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

          sed -i 's/^          //' /tmp/pr_comment.md

          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file /tmp/pr_comment.md \
            --repo ${{ github.repository }}

  publish-nuget:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.outputs.is_release == 'true' }}
    environment: nuget-production
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Authenticate to NuGet.org
        uses: nuget/login@v1
        id: nuget-login
        with:
          user: ${{ secrets.NUGET_USERNAME }}

      - name: Push to NuGet.org
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} \
            --source "https://api.nuget.org/v3/index.json" \
            --skip-duplicate

      - name: Create git tag and GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.build.outputs.base_version }}
        run: |
          TAG="v${VERSION}"

          if gh release view "$TAG" --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "Release $TAG already exists, skipping"
            exit 0
          fi

          cat > /tmp/release_notes.md << EOF
          ## Sigstore ${VERSION}

          ### Install

          \`\`\`bash
          dotnet add package Sigstore --version ${VERSION}
          dotnet add package Tuf --version ${VERSION}
          \`\`\`

          ### Links
          - ðŸ“– [Documentation](https://mitchdenny.github.io/sigstore-dotnet/)
          - ðŸ“¦ [Sigstore on NuGet](https://www.nuget.org/packages/Sigstore/${VERSION})
          - ðŸ“¦ [Tuf on NuGet](https://www.nuget.org/packages/Tuf/${VERSION})

          ---
          *Released from commit ${{ github.sha }}*
          EOF

          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file /tmp/release_notes.md \
            --target ${{ github.sha }} \
            ./artifacts/*.nupkg

      - name: Bump version tags
        env:
          VERSION: ${{ needs.build.outputs.base_version }}
        run: |
          MAJOR=$(echo "$VERSION" | cut -d'.' -f1)
          MINOR=$(echo "$VERSION" | cut -d'.' -f2)

          # Tag main with next dev version so main builds target X.(Y+1).0
          NEXT_MINOR=$((MINOR + 1))
          DEV_TAG="v${MAJOR}.${NEXT_MINOR}.0-dev"

          # Only create dev tag if it doesn't exist
          if ! git tag -l "$DEV_TAG" | grep -q "$DEV_TAG"; then
            # Fetch main branch tip
            git fetch origin main --quiet
            git tag "$DEV_TAG" origin/main
            git push origin "$DEV_TAG"
            echo "Created dev tag: $DEV_TAG on main"
          else
            echo "Dev tag $DEV_TAG already exists, skipping"
          fi

  deploy-docs:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    concurrency:
      group: pages
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Install docfx
        run: dotnet tool install -g docfx

      - name: Build documentation
        run: docfx docfx.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
